<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Liturgie Dashboard</title>
  <link rel="stylesheet" href="/styles.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,100..700;1,100..700&family=Urbanist:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
  <style>
    .save-button-container {
      position: fixed;
      bottom: 30px;
      right: 30px;
      z-index: 1000;
    }

    .save-button {
      padding: 15px 30px;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      transition: all 0.2s;
      font-family: "Urbanist", sans-serif;
    }

    .save-button:hover {
      background: #1d4ed8;
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
    }

    .save-button:disabled {
      background: #666;
      cursor: not-allowed;
      transform: none;
    }

    .save-status {
      position: fixed;
      bottom: 90px;
      right: 30px;
      background: rgba(0, 0, 0, 0.8);
      color: #90ee90;
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 14px;
      z-index: 1000;
      display: none;
      font-family: "Urbanist", sans-serif;
    }

    .save-status.show {
      display: block;
    }

    .liturgie-line[contenteditable="true"] {
      cursor: text;
      outline: 2px solid transparent;
      transition: outline 0.2s;
      white-space: nowrap;
    }

    .liturgie-line[contenteditable="true"]:focus {
      outline: 2px solid rgba(37, 99, 235, 0.5);
    }

    .liturgie-line[contenteditable="true"]:hover {
      outline: 2px solid rgba(37, 99, 235, 0.3);
    }
  </style>
</head>
<body>
  <div class="liturgie-container">
    <div id="liturgie" class="liturgie-tekst">
      Liturgie wordt geladen...
    </div>
  </div>

  <div class="save-button-container">
    <button id="save-button" class="save-button">Opslaan</button>
  </div>
  <div id="save-status" class="save-status"></div>

  <script>
    function renderLiturgie(tekst) {
      const el = document.getElementById("liturgie");
      
      // Split text into lines and render each as a liturgie-line
      const textLines = tekst.split('\n').map(line => {
        if (line.trim() === "") {
          return '<div class="liturgie-line" contenteditable="true">&nbsp;</div>';
        }
        
        // Wrap each character in a letter-block span, including spaces
        const content = Array.from(line).map(char =>
          char === " "
            ? `<span class="letter-block space"> </span>`
            : `<span class="letter-block">${char}</span>`
        ).join("");
        
        return `<div class="liturgie-line" contenteditable="true">${content}</div>`;
      });
      
      // Calculate how many empty lines are needed to fill the viewport
      const lineHeight = 120 + 7; // min-height + border-bottom
      const viewportHeight = window.innerHeight;
      const contentHeight = textLines.length * lineHeight;
      const emptyLinesNeeded = Math.max(0, Math.ceil((viewportHeight - contentHeight) / lineHeight));
      
      // Add empty lines to fill the viewport
      const emptyLines = Array(emptyLinesNeeded).fill('<div class="liturgie-line" contenteditable="true">&nbsp;</div>');
      
      el.innerHTML = textLines.concat(emptyLines).join("");
    }

    function extractTextFromLiturgie() {
      const el = document.getElementById("liturgie");
      const lines = el.querySelectorAll('.liturgie-line');
      const textLines = [];
      
      for (const line of lines) {
        let lineText = '';
        
        // Extract text preserving all spaces
        for (const node of line.childNodes) {
          if (node.nodeType === Node.TEXT_NODE) {
            // Replace non-breaking spaces with regular spaces
            lineText += node.textContent.replace(/ /g, ' ');
          } else if (node.classList && node.classList.contains('letter-block')) {
            // Get text content, handling both regular characters and spaces
            lineText += node.textContent;
          }
        }
        
        // Treat lines with only whitespace (including nbsp) as empty lines
        // This preserves empty lines when saving
        if (lineText.trim() === '') {
          textLines.push('');
        } else {
          textLines.push(lineText);
        }
      }
      
      // Remove trailing empty lines that are just viewport fillers
      while (textLines.length > 0 && textLines[textLines.length - 1] === '') {
        textLines.pop();
      }
      
      return textLines.join('\n');
    }

    async function laadLiturgie() {
      try {
        const res = await fetch("/api/get-liturgie");
        const data = await res.json();
        const tekst = data.tekst || "";
        renderLiturgie(tekst);
      } catch (err) {
        console.error(err);
        document.getElementById("liturgie").textContent = "Fout bij laden van de liturgie.";
      }
    }

    async function opslaanLiturgie() {
      const saveBtn = document.getElementById("save-button");
      const statusEl = document.getElementById("save-status");
      
      try {
        saveBtn.disabled = true;
        statusEl.textContent = "Bezig met opslaan...";
        statusEl.classList.add("show");

        const tekst = extractTextFromLiturgie();

        const res = await fetch("/api/set-liturgie", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ tekst: tekst })
        });

        const data = await res.json();

        if (data.ok) {
          statusEl.textContent = "Opgeslagen!";
          setTimeout(() => {
            statusEl.classList.remove("show");
          }, 3000);
        } else {
          statusEl.textContent = "Fout bij opslaan.";
          statusEl.style.color = "#ff6b6b";
        }
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Fout bij opslaan.";
        statusEl.style.color = "#ff6b6b";
      } finally {
        saveBtn.disabled = false;
      }
    }

    document.getElementById("save-button").addEventListener("click", opslaanLiturgie);

    // Handle Enter key to create new lines properly
    document.getElementById("liturgie").addEventListener("keydown", function(e) {
      if (e.key === "Enter") {
        e.preventDefault();
        const selection = window.getSelection();
        const range = selection.getRangeAt(0);
        
        // Insert a newline by creating a new line div
        const newLine = document.createElement("div");
        newLine.className = "liturgie-line";
        newLine.contentEditable = "true";
        newLine.innerHTML = "&nbsp;";
        
        // Find the current line
        let currentLine = range.startContainer;
        while (currentLine && !currentLine.classList?.contains("liturgie-line")) {
          currentLine = currentLine.parentNode;
        }
        
        if (currentLine && currentLine.nextSibling) {
          currentLine.parentNode.insertBefore(newLine, currentLine.nextSibling);
        } else if (currentLine) {
          currentLine.parentNode.appendChild(newLine);
        }
        
        // Move cursor to new line
        const newRange = document.createRange();
        newRange.setStart(newLine, 0);
        newRange.collapse(true);
        selection.removeAllRanges();
        selection.addRange(newRange);
      }
    });

    laadLiturgie();
  </script>
</body>
</html>
